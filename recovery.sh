#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞
if [[ $# -eq 0 ]]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 –ø—É—Ç—å_–∫_csv_—Ñ–∞–π–ª—É"
    exit 1
fi

CSV_FILE="$1"
SEPARATOR=";"  # –£–∫–∞–∂–∏—Ç–µ –≤–∞—à —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (; –∏–ª–∏ ,)
PASSWORD="P@ssw0rd1"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ samba-tool
if ! command -v samba-tool &> /dev/null; then
    echo "–û—à–∏–±–∫–∞: samba-tool –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

echo "üîÑ –ù–∞—á–∏–Ω–∞—é —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞ $CSV_FILE"

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏
while IFS="$SEPARATOR" read -r first_name last_name _ _ _ _ _ _ _ _
do
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞ (–ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∏–º–µ–Ω–∏ + —Ñ–∞–º–∏–ª–∏—è –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
    username=$(echo "${first_name:0:1}${last_name}" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alpha:]')
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if samba-tool user list | grep -q "^${username}$"; then
        echo "üîß –û–±–Ω–æ–≤–ª—è—é –ø–∞—Ä–æ–ª—å –¥–ª—è: $username"
        if samba-tool user setpassword "$username" --newpassword="$PASSWORD"; then
            echo "‚úÖ –ü–∞—Ä–æ–ª—å –¥–ª—è $username —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è –¥–ª—è $username"
        fi
    else
        echo "‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $username –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞—é"
    fi
done < <(tail -n +2 "$CSV_FILE")  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫

echo "üéâ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"